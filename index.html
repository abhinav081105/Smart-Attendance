<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Page</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      margin: auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px #0001;
    }
    th, td {
      padding: 10px 14px;
      border: 1px solid #e0e0e0;
      text-align: center;
      font-size: 1rem;
    }
    th {
      background-color: #e3eafc;
      font-weight: 600;
      color: #1a237e;
    }
    button {
      cursor: pointer;
      border: none;
      padding: 7px 16px;
      margin: 0 2px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 1rem;
      transition: background 0.2s, color 0.2s;
    }
    .present {
      background-color: #e0f7e9;
      color: #222;
    }
    .absent {
      background-color: #ffebee;
      color: #222;
    }
    .permission {
      background-color: #fff8e1;
      color: #222;
    }
    .selected.present {
      background-color: #388e3c !important;
      color: #fff !important;
    }
    .selected.absent {
      background-color: #b71c1c !important;
      color: #fff !important;
    }
    .selected.permission {
      background-color: #f9a825 !important;
      color: #fff !important;
    }
    .section-label {
      font-weight: bold;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 3px;
      background-color: #dedede;
    }
    input[readonly] {
      background: #f5f5f5;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      width: 140px;
      margin-left: 8px;
      font-size: 1rem;
    }
    #submitAttendance:hover {
      background: #1251a3;
    }
  </style>
</head>
<body>

  <div class="container">
    <div style="text-align:center; margin-bottom:18px;">
      <img src="college-logo.png" alt="Lendi College Logo" style="max-width:100%; height:80px; margin-bottom:10px;">
      <h2>3rd CSE Attendance Sheet</h2>
    </div>

    <div style="text-align:center; margin-bottom:24px;">
      <label for="sectionSelect">Select Section:</label>
      <select id="sectionSelect">
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>
    </div>

    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Register Number</th>
            <th>Section</th>
            <th>Present</th>
            <th>Absent</th>
            <th>Absent with Permission</th>
            <th>Status Selected</th>
          </tr>
        </thead>
        <tbody id="attendanceBody"></tbody>
      </table>
    </div>

    <div style="text-align:center; margin-top:28px;">
      <button id="submitAttendance">
        Submit Attendance
      </button>
    </div>

    <div id="attendanceSummary" style="margin-top:30px; text-align:center; font-size:16px;"></div>
  </div>

  <script>
    // Helper: "01"-"99", then "A0"-"A9", "B0"-"B9", etc
    function generateRollSequence() {
      const numbers = [];
      for (let i = 1; i <= 99; i++) numbers.push(i.toString().padStart(2, '0'));
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      for (let l of letters) for (let n = 0; n < 10; n++) numbers.push(l+n);
      return numbers;
    }
    const rollSeq = generateRollSequence();

    // Build regular register numbers: 23KD1A05 + rollSeq
    const getRegularRegNo = roll => `23KD1A05${roll}`;
    // Build lateral register numbers: 24KD5A05 + rollSeq
    const getLateralRegNo = roll => `24KD5A05${roll}`;
    // Section codes and lateral per section
    const sections = ['A','B','C','D'];
    const lateralDist = [
      { section: 'A', count: 5 }, // 01-06
      { section: 'B', count: 6 }, // 07-11
      { section: 'C', count: 6 }, // 12-17
      { section: 'D', count: 8 }  // 18-22
    ];

    // 1. Distribute regular students: 66 to A, 66 to B, 66 to C, 82 to D
    let regIdx = 0, allStudents = [];
    for(let secIdx = 0; secIdx < 4; secIdx++) {
      let regPerSection = (secIdx < 3) ? 66 : (280 - 66*3); // 66,66,66,82
      let regs = [];
      for(let i=0; i<regPerSection; i++) {
        regs.push({registerNumber: getRegularRegNo(rollSeq[regIdx++]), section: sections[secIdx]});
      }
      allStudents.push({regulars: regs, section: sections[secIdx]});
    }
    // 2. Lateral entries: slice appropriate rollSeq segment and distribute per section
    let lateralOffset = 0;
    for(let secIdx = 0; secIdx < 4; secIdx++) {
      let count = lateralDist[secIdx].count;
      let lateralRegs = [];
      for(let i=0; i<count; i++) {
        lateralRegs.push({registerNumber: getLateralRegNo(rollSeq[lateralOffset++]), section: sections[secIdx]});
      }
      allStudents[secIdx].laterals = lateralRegs;
    }
    // 3. Merge: insert lateral after regulars for each section
    let merged = [];
    for(let secIdx = 0; secIdx < 4; secIdx++) {
      const secObj = allStudents[secIdx];
      if(secIdx < 3) {
        merged.push(...secObj.regulars, ...secObj.laterals);
      } else {
        // For D section: only up to Q3 for regulars, then laterals up to 25
        // Find index of Q3 in regulars
        const lastRegIdx = secObj.regulars.findIndex(stu => stu.registerNumber.endsWith('Q3'));
        let dRegulars = secObj.regulars.slice(0, lastRegIdx + 1);
        let dLaterals = secObj.laterals.slice(0, 25);
        merged.push(...dRegulars, ...dLaterals);
      }
    }

    // Group students by section for filtering
    const studentsBySection = { A: [], B: [], C: [], D: [] };
    merged.forEach(stu => studentsBySection[stu.section].push(stu));

    // Store attendance state for each section (so switching doesn't lose selection)
    const attendanceState = { A: {}, B: {}, C: {}, D: {} };

    // Render table for a section
    function renderTable(section) {
      const tbody = document.getElementById('attendanceBody');
      tbody.innerHTML = '';
      studentsBySection[section].forEach(student => {
        const tr = document.createElement('tr');
        // Register Number
        const tdReg = document.createElement('td');
        tdReg.textContent = student.registerNumber;
        tr.appendChild(tdReg);
        // Section
        const tdSection = document.createElement('td');
        tdSection.textContent = student.section;
        tdSection.className = 'section-label';
        tr.appendChild(tdSection);

        // Create status text box
        const tdStatusText = document.createElement('td');
        tdStatusText.colSpan = 3; // Will be moved after the buttons

        // Button helper
        function createStatusButton(text, className, regNo) {
          const btn = document.createElement('button');
          btn.textContent = text;
          btn.className = className;
          btn.addEventListener('click', () => {
            tr.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            attendanceState[section][regNo] = className;
            // Update status text box
            statusBox.value = text;
          });
          return btn;
        }
        // Present
        const tdPresent = document.createElement('td');
        tdPresent.appendChild(createStatusButton('Present', 'present', student.registerNumber));
        tr.appendChild(tdPresent);
        // Absent
        const tdAbsent = document.createElement('td');
        tdAbsent.appendChild(createStatusButton('Absent', 'absent', student.registerNumber));
        tr.appendChild(tdAbsent);
        // Permission
        const tdPerm = document.createElement('td');
        tdPerm.appendChild(createStatusButton('Permission', 'permission', student.registerNumber));
        tr.appendChild(tdPerm);

        // Status text box (readonly)
        const statusBox = document.createElement('input');
        statusBox.type = 'text';
        statusBox.readOnly = true;
        statusBox.style.width = '140px';
        statusBox.style.textAlign = 'center';
        statusBox.style.background = '#f5f5f5';
        statusBox.style.border = '1px solid #ccc';
        statusBox.style.marginLeft = '8px';

        // Set initial value
        const prev = attendanceState[section][student.registerNumber];
        if (prev) {
          tr.querySelector(`button.${prev}`).classList.add('selected');
          statusBox.value = prev === 'present' ? 'Present' : prev === 'absent' ? 'Absent' : 'Absent with Permission';
        } else {
          tr.querySelector('button.present').classList.add('selected');
          attendanceState[section][student.registerNumber] = 'present';
          statusBox.value = 'Present';
        }

        // Add status box at the end
        const tdStatus = document.createElement('td');
        tdStatus.appendChild(statusBox);
        tr.appendChild(tdStatus);

        tbody.appendChild(tr);
      });
    }

    // Initial render
    let currentSection = 'A';
    renderTable(currentSection);

    // Section dropdown event
    document.getElementById('sectionSelect').addEventListener('change', function() {
      currentSection = this.value;
      renderTable(currentSection);
      document.getElementById('attendanceSummary').innerHTML = '';
    });

    // Store all sections' attendance in localStorage
    if (!localStorage.getItem('allAttendance')) {
      localStorage.setItem('allAttendance', JSON.stringify({}));
    }

    // Clear previous attendance data if starting a new session
    if (localStorage.getItem('attendanceStarted') !== 'yes') {
      localStorage.setItem('allAttendanceData', JSON.stringify([]));
      localStorage.setItem('attendanceStarted', 'yes');
    }
    if (currentSection === 'A') {
      localStorage.setItem('allAttendanceData', JSON.stringify([]));
    }

    // Submit attendance
    document.getElementById('submitAttendance').addEventListener('click', async function() {
      const tbody = document.getElementById('attendanceBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      let present = 0, absent = 0, permission = 0;
      let absentees = [], permissions = [];
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;

      const attendanceData = rows.map(row => {
        const regNo = row.children[0].textContent;
        const btns = row.querySelectorAll('button');
        let status = 'present';
        if (btns[0].classList.contains('selected')) status = 'present';
        else if (btns[1].classList.contains('selected')) status = 'absent';
        else if (btns[2].classList.contains('selected')) status = 'permission';

        if (status === 'present') present++;
        if (status === 'absent') { absent++; absentees.push(regNo); }
        if (status === 'permission') { permission++; permissions.push(regNo); }

        return { registerNumber: regNo, section: currentSection, status, date: dateStr };
      });

      // Send each attendance record to backend
      for (const att of attendanceData) {
        try {
          await fetch('http://localhost:3000/attendance', { // Use your backend URL
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(att)
          });
        } catch (e) {
          console.error('Failed to save attendance for', att.registerNumber, e);
        }
      }

      // Save only this section's data
      localStorage.setItem('attendanceSummary', JSON.stringify({
        present, absent, permission, absentees, permissions, section: currentSection
      }));
      localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

      // Change button to green and show "Submitted"
      const submitBtn = document.getElementById('submitAttendance');
      submitBtn.textContent = 'Submitted';
      submitBtn.style.background = '#388e3c';
      submitBtn.style.color = '#fff';
      submitBtn.disabled = true;

      setTimeout(() => {
        window.location.href = 'summary.html';
      }, 800);
    });
  </script>
</body>
</html>
